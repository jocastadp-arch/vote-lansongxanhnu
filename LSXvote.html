<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LSX Vote Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
 --primary:#0f766e; --primary-dark:#064e4a;
 --bg:#ecfdf5; --card:#d1fae5; --text:#022c22;
}
*{box-sizing:border-box}
body{margin:0;font-family:Montserrat,sans-serif;background:var(--bg);color:var(--text);}
header{background:linear-gradient(90deg,var(--primary),var(--primary-dark));color:#fff;padding:24px;text-align:center;font-size:26px;font-weight:700}
nav{display:flex;justify-content:center;gap:14px;background:#0d9488;padding:14px;flex-wrap:wrap}
nav button{border:none;padding:12px 28px;border-radius:999px;background:rgba(255,255,255,.2);color:white;font-size:15px;font-weight:700;cursor:pointer}
nav button.active{background:white;color:var(--primary-dark)}
.last-update{padding:6px 20px;font-size:12px;color:#064e4a;font-weight:600;text-align:right;}
section{display:none;padding:20px}
section.active{display:block}
.card{background:var(--card);border-radius:18px;padding:20px;box-shadow:0 8px 22px rgba(0,0,0,.1)}
h2{margin-top:0;font-size:22px}

/* TABLE */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;min-width:400px}
th,td{padding:10px;border-bottom:1px solid #99d5c8;font-size:14px;text-align:center;white-space:nowrap}
th{background:#5eead4}
.vote-up{color:#047857;font-weight:700}
.top1{background:#fde68a;font-weight:700}
.top2{background:#e5e7eb;font-weight:700}
.top3{background:#fed7aa;font-weight:700}
.top45{background:#ccfbf1}

/* BUTTONS */
button.small, select.small{padding:8px 14px;border:none;border-radius:10px;background:var(--primary);color:white;font-weight:600;cursor:pointer}

/* CHART */
.chart-wrap{height:260px}
@media(min-width:1024px){.chart-wrap{height:320px}}

/* MODAL */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:#ecfdf5;width:92%;max-width:520px;max-height:80vh;overflow:auto;border-radius:18px;padding:22px}
.modal-header{display:flex;justify-content:space-between;align-items:center}
.close{font-size:22px;font-weight:700;cursor:pointer}
label{display:inline-block;margin:6px 14px 6px 0}

/* FOOTER */
footer{margin-top:40px;padding:28px 16px;text-align:center;background:linear-gradient(180deg,#0d9488,#064e4a);color:#ecfdf5;border-top-left-radius:24px;border-top-right-radius:24px}
.footer-title{font-size:20px;font-weight:700;letter-spacing:1px;margin-bottom:10px;background:linear-gradient(90deg,#5eead4,#22d3ee,#5eead4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-size:200% auto;animation:wave 4s linear infinite}
@keyframes wave{to{background-position:200% center}}
.footer-link a{color:#a7f3d0;font-weight:600;text-decoration:none}
.footer-note{margin-top:12px;font-size:13px;color:#ccfbf1;line-height:1.6}

/* RESPONSIVE */
@media(max-width:600px){
 h2{font-size:18px}
 th,td{padding:6px;font-size:12px}
 nav button{padding:8px 14px;font-size:13px}
 .last-update{text-align:left;padding-left:8px;font-size:11px}
}
</style>
</head>
<body>

<header>LSX Vote Tracker</header>

<nav>
<button id="tabArtists" class="active">Ngh·ªá sƒ©</button>
<button id="tabChart">Bi·ªÉu ƒë·ªì</button>
<button id="tabHistory">L·ªãch s·ª≠</button>
</nav>

<div class="last-update" id="lastUpdate">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: --:--:--</div>

<section id="artistsSection" class="active">
<div class="card">
<h2>B·∫£ng ngh·ªá sƒ©</h2>
<div class="table-wrap"><table id="summaryTable"></table></div>
</div>
</section>

<section id="chartSection">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<h2>Bi·ªÉu ƒë·ªì tƒÉng tr∆∞·ªüng</h2>
<button class="small" onclick="openModal()">Ch·ªçn ngh·ªá sƒ©</button>
</div>
<div class="chart-wrap"><canvas id="voteChart"></canvas></div>
</div>
</section>

<section id="historySection">
<div class="card">
<h2>L·ªãch s·ª≠ x·∫øp h·∫°ng</h2>
<div style="margin-bottom:12px">
<select id="historyFilter" class="small" onchange="renderHistory()">
<option value="10">10 ph√∫t</option>
<option value="30">30 ph√∫t</option>
<option value="60">1 gi·ªù</option>
<option value="300">5 gi·ªù</option>
<option value="720">12 gi·ªù</option>
</select>
</div>
<div class="table-wrap"><table id="historyTable"></table></div>
</div>
</section>

<div id="artistModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3>Ch·ªçn ngh·ªá sƒ© hi·ªÉn th·ªã</h3>
<span class="close" onclick="closeModal()">√ó</span>
</div>
<div style="margin:12px 0">
<button class="small" onclick="selectAll()">Ch·ªçn t·∫•t c·∫£</button>
<button class="small" onclick="clearAll()">B·ªè ch·ªçn</button>
</div>
<div id="controls"></div>
</div>
</div>

<script>
const API_URL="https://lsxvote.jdiep72.workers.dev/";
const REFRESH_INTERVAL=10000;
let chart, artistsMap={}, lastVotes={};
const HISTORY_KEY="lsx_vote_history", HISTORY_INTERVALS=[10,30,60,300,720];
let lastHistorySave=JSON.parse(localStorage.getItem("lsx_last_save")||"{}");

const sections={artists:document.getElementById("artistsSection"), chart:document.getElementById("chartSection"), history:document.getElementById("historySection")};
const summaryTable=document.getElementById("summaryTable");
const historyTable=document.getElementById("historyTable");
const lastUpdate=document.getElementById("lastUpdate");
const tabs={artists:document.getElementById("tabArtists"), chart:document.getElementById("tabChart"), history:document.getElementById("tabHistory")};
const controls=document.getElementById("controls");

Object.keys(tabs).forEach(t=>tabs[t].onclick=()=>showTab(t));
function showTab(t){
  Object.keys(sections).forEach(k=>sections[k].classList.toggle("active",k===t));
  Object.keys(tabs).forEach(k=>tabs[k].classList.toggle("active",k===t));
  if(t==="history") renderHistory();
}
function updateLastUpdate(){lastUpdate.textContent="C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: "+new Date().toLocaleTimeString();}
function openModal(){document.getElementById("artistModal").classList.add("active");}
function closeModal(){document.getElementById("artistModal").classList.remove("active");}
function randomColor(){return `hsl(${Math.random()*360},70%,45%)`;}
function initChart(){
  chart=new Chart(voteChart,{
    type:"line",
    data:{labels:[], datasets:[]},
    options:{
      responsive:true, maintainAspectRatio:false,
      animation:false, elements:{line:{tension:.35}, point:{radius:0}},
      plugins:{legend:{display:false}}
    }
  });
}

function renderControls(){
  controls.innerHTML="";
  chart.data.datasets.forEach((ds,i)=>{
    const cb=document.createElement("input");
    cb.type="checkbox"; cb.checked=!ds.hidden;
    cb.onchange=()=>{ds.hidden=!cb.checked; chart.update();}
    const label=document.createElement("label");
    label.appendChild(cb); label.appendChild(document.createTextNode(" "+ds.label));
    controls.appendChild(label);
  });
}
function selectAll(){chart.data.datasets.forEach(d=>d.hidden=false); renderControls(); chart.update();}
function clearAll(){chart.data.datasets.forEach(d=>d.hidden=true); renderControls(); chart.update();}

function updateTable(list){
  const frag=document.createDocumentFragment();
  summaryTable.innerHTML=`<tr><th>H·∫°ng</th><th>Ngh·ªá sƒ©</th><th>Vote</th><th>Thay ƒë·ªïi</th><th>Tri·ªáu VNƒê</th></tr>`;
  list.sort((a,b)=>b.points-a.points).forEach((a,i)=>{
    const tr=document.createElement("tr");
    tr.className=i===0?"top1":i===1?"top2":i===2?"top3":i<5?"top45":"";
    tr.innerHTML=`<td>${i===0?"üèÜ":i+1}</td><td>${a.name}</td><td>${a.points}</td><td class="vote-up">${a.diff>0?`+${a.diff}`:"0"}</td><td>${((a.points/10)*0.003).toFixed(3)}</td>`;
    frag.appendChild(tr);
  });
  summaryTable.appendChild(frag);
}

function saveHistory(summary){
  const now=Date.now();
  let history=JSON.parse(localStorage.getItem(HISTORY_KEY)||"{}");
  HISTORY_INTERVALS.forEach(min=>{
    const ms=min*60000;
    if(!lastHistorySave[min]||now-lastHistorySave[min]>=ms){
      history[min]=history[min]||[];
      const prev=(history[min].length>0)?history[min][history[min].length-1].data:[];
      const snapshot=summary.map(s=>{
        const prevPoints=(prev.find(p=>p.name===s.name)||{points:0}).points;
        return {name:s.name, points:s.points, diff:s.points-prevPoints};
      });
      history[min].push({time:new Date().toLocaleString(), data:snapshot});
      lastHistorySave[min]=now;
    }
  });
  localStorage.setItem(HISTORY_KEY,JSON.stringify(history));
  localStorage.setItem("lsx_last_save",JSON.stringify(lastHistorySave));
}

function renderHistory(){
  const min=document.getElementById("historyFilter").value;
  const history=JSON.parse(localStorage.getItem(HISTORY_KEY)||"{}");
  historyTable.innerHTML=`<tr><th>Th·ªùi ƒëi·ªÉm</th><th>H·∫°ng</th><th>Ngh·ªá sƒ©</th><th>Vote</th><th>Thay ƒë·ªïi</th></tr>`;
  if(!history[min]) return;
  const frag=document.createDocumentFragment();
  history[min].slice().reverse().forEach(b=>{
    b.data.sort((a,b)=>b.points-a.points).forEach((a,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${b.time}</td><td>${i+1}</td><td>${a.name}</td><td>${a.points}</td><td class="vote-up">${a.diff>0?`+${a.diff}`:a.diff<0?`${a.diff}`:"0"}</td>`;
      frag.appendChild(tr);
    });
  });
  historyTable.appendChild(frag);
}

async function refreshData(){
  try{
    const resp=await fetch(API_URL);
    const products=(await resp.json())?.data?.products||[];
    if(!products.length) return;
    const summary=[];
    chart.data.labels.push(new Date().toLocaleTimeString());
    products.forEach(p=>{
      if(!artistsMap[p.id]){
        artistsMap[p.id]={label:p.name,data:[],borderColor:randomColor(),borderWidth:2};
        chart.data.datasets.push(artistsMap[p.id]);
      }
      const pts=p.points||0;
      const diff=lastVotes[p.id]!==undefined?pts-lastVotes[p.id]:0;
      lastVotes[p.id]=pts;
      artistsMap[p.id].data.push(pts);
      summary.push({name:p.name, points:pts, diff});
    });
    chart.update();
    renderControls();
    updateTable(summary);
    saveHistory(summary);
    updateLastUpdate();
  } catch(e){console.error("Error fetching data:", e);}
}

initChart(); refreshData(); setInterval(refreshData, REFRESH_INTERVAL);
</script>

<footer>
<div class="footer-title">L√ÄN S√ìNG XANH MUSIC AWARD</div>
<div class="footer-link">üëâ <a href="https://lansongxanh.1vote.vn/" target="_blank">Truy c·∫≠p trang vote ch√≠nh th·ª©c</a></div>
<div class="footer-note">¬© B·∫£n quy·ªÅn thu·ªôc v·ªÅ <strong>Eventista</strong><br>Ph√°t tri·ªÉn b·ªüi ng∆∞·ªùi h√¢m m·ªô Ngh·ªá Sƒ© <strong>LYHAN</strong></div>
</footer>

</body>
</html>
